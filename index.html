<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Crédito Rural — Mapa (MTS) • Sidebar Fixo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    :root { --sidebar-w: 320px; }
    html, body { height:100%; margin:0; }
    #map { position:absolute; inset:0; }

    .sidebar {
      position: fixed; left: 12px; top: 12px; bottom: 12px; width: var(--sidebar-w);
      display:flex; flex-direction:column; gap:10px; z-index: 10;
      pointer-events:auto; overflow:auto;
    }
    .card {
      background:#ffffffcc; backdrop-filter: blur(4px);
      border:1px solid #ddd; border-radius:12px; padding:10px 12px;
      font:12px system-ui; box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
    .kpis { display:grid; grid-template-columns: repeat(2, minmax(120px, 1fr)); gap:8px; }
    .kpi { border:1px solid #eee; border-radius:8px; padding:8px; background:#fff; }
    .kpi .label { color:#666; font-weight:600; font-size:11px; }
    .kpi .value { font-size:16px; font-weight:700; margin-top:2px; }

    .totais h3 { margin:0 0 6px; font:600 13px/1.2 system-ui; color:#333; }
    .totais .row { display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-top:1px dashed #e6e6e6; }
    .totais .row:first-child { border-top:0; }
    .totais .row .label { color:#555; }
    .totais .inst-list { margin-top:8px; max-height:220px; overflow:auto; border:1px solid #eee; border-radius:8px; background:#fff; }
    .totais .inst-list table { width:100%; border-collapse:collapse; font-size:12px; }
    .totais .inst-list th, .totais .inst-list td { padding:6px 8px; border-bottom:1px solid #f0f0f0; text-align:left; }
    .totais .inst-list th { position:sticky; top:0; background:#fafafa; z-index:1; }

    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .toolbar input[type="text"] { width: 240px; padding:6px 8px; border:1px solid #ccc; border-radius:6px; }
    .toolbar button { border:1px solid #ccc; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; }
    .toolbar label { display:flex; align-items:center; gap:6px; cursor:pointer; }

    .filters { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .flt { display:flex; align-items:center; gap:6px; }
    .flt input[type="checkbox"] { transform: translateY(1px); }

    .result-list { margin-top:8px; max-height:240px; overflow:auto; border:1px solid #eee; border-radius:8px; background:#fff; }
    .result-list table { width:100%; border-collapse:collapse; font-size:12px; }
    .result-list th, .result-list td { padding:6px 8px; border-bottom:1px solid #f0f0f0; text-align:left; }
    .result-list tr:hover { background:#f5f5f5; cursor:pointer; }
    .result-actions { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .result-actions button { border:1px solid #ccc; background:#fff; border-radius:6px; padding:6px 10px; cursor:pointer; }

    .mapboxgl-popup { max-width: 480px; font: 12px/1.45 system-ui, -apple-system, "Segoe UI", sans-serif; }
    .mapboxgl-popup table { border-collapse: collapse; width: 100%; }
    .mapboxgl-popup th, .mapboxgl-popup td { padding: 4px 6px; vertical-align: top; }
    .mapboxgl-popup th { width: 40%; text-align: right; color: #555; font-weight: 600; }

    .badge { margin-top:auto; font-size:11px; color:#666; text-align:left; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
  <div class="card totais">
    <h3>Totais (dataset)</h3>
    <div class="row"><span class="label">Total de CAR</span><strong id="tot-car">—</strong></div>
    <div class="row"><span class="label">Soma Total de Crédito (R$)</span><strong id="tot-credito">—</strong></div>
    <div class="row"><span class="label">Desmatamento total (ha)</span><strong id="tot-desmate">—</strong></div>
    <div class="row"><span class="label">Focos de incêndio (qtd)</span><strong id="tot-focos">—</strong></div>
    <div class="row"><span class="label">Quantidade em Terras Indígenas</span><strong id="tot-ti">—</strong></div>
    <div class="row"><span class="label">Quantidade em Unidades de Conservação</span><strong id="tot-uc">—</strong></div>

    <div class="inst-list" aria-label="Quantidade por instituição">
      <table>
        <thead><tr><th>Instituição (CNPJ básico)</th><th>Qtd. CAR</th></tr></thead>
        <tbody id="tot-inst-list"><tr><td colspan="2">Carregando…</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="kpis" title="KPIs da área visível no mapa">
      <div class="kpi">
        <div class="label">Crédito visível (R$)</div>
        <div class="value" id="kpi-credito">—</div>
      </div>
      <div class="kpi">
        <div class="label">Desmatamento visível (ha)</div>
        <div class="value" id="kpi-desmate">—</div>
      </div>
      <div class="kpi">
        <div class="label">CARs visíveis</div>
        <div class="value" id="kpi-cars">—</div>
      </div>
      <div class="kpi">
        <div class="label">Com embargo (visível)</div>
        <div class="value" id="kpi-embargos">—</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <input id="search" placeholder="Buscar por cód. imóvel (cod_imovel)" />
      <input id="search-embargo" placeholder="Buscar autuado por embargo (emb_nome)" list="embargo-suggestions" />
      <datalist id="embargo-suggestions"></datalist>
      <button id="zoom-br">Amazônia/BR</button>
      <label><input type="checkbox" id="toggle-ti" checked> Terras Indígenas</label>
      <label><input type="checkbox" id="toggle-uc" checked> Unidades de Conservação</label>
    </div>
  </div>

  <div class="card">
    <div class="filters">
      <label class="flt"><input type="checkbox" id="only-embargo"> Só com embargo</label>
      <label class="flt"><input type="checkbox" id="only-ti"> Só em TI</label>
      <label class="flt"><input type="checkbox" id="only-uc"> Só em UC</label>
      <button id="apply-filters">Aplicar filtros</button>
      <button id="reset-filters">Limpar</button>
    </div>
  </div>

  <div class="card">
    <div class="result-actions">
      <strong>Resultados filtrados</strong>
      <button id="download-csv">Baixar CSV</button>
    </div>
    <div class="result-list" aria-label="Resultados filtrados">
      <table>
        <thead><tr><th>Cod. Imóvel</th><th>Município</th><th>Total CR (R$)</th></tr></thead>
        <tbody id="result-rows"><tr><td colspan="3">Carregando…</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="badge"><span id="layerName">—</span></div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiaW5mb2FtYXpvbmlhIiwiYSI6ImNtNzRxN2lmODBjOTYya29tbDhsYnJwMDEifQ.xfHyTw_HCoxQzI0TNVYCHg';

const TILESET   = 'infoamazonia.credito';
const STYLE_URL = 'mapbox://styles/infoamazonia/cmhavswvo002u01s19eakho0b';

const FIELDS = {
  id_car: 'id_car',
  cod_imovel: 'cod_imovel',
  municipio: 'municipio',
  total_CR: 'total_CR',
  embargo_count: 'embargo_count',
  embargo_area_ha: 'embargo_area_ha',
  emb_nome: 'emb_nome',
  desmate: 'Desmatamento_ha',
  UC: 'UC',
  TI: 'TI',
  area_afetada: 'area_afetada',
  focos_count: 'focos_count',
  focos_anos: 'focos_anos',
  valor_parcela_credito: 'valor_parcela_credito',
  cnpj_basico: 'cnpj_basico_instituicao_financeira'
};

const POPUP_FIELDS = [
  ['ID CAR', FIELDS.id_car],
  ['Cod. Imóvel', FIELDS.cod_imovel],
  ['Município', FIELDS.municipio],
  ['Total em Crédito Rural (R$)', FIELDS.total_CR],
  ['Embargos (qtd)', FIELDS.embargo_count],
  ['Área Embargada (ha)', FIELDS.embargo_area_ha],
  ['Autuado por embargo', FIELDS.emb_nome],
  ['Desmatamento (ha)', FIELDS.desmate],
  ['UC', FIELDS.UC],
  ['TI', FIELDS.TI],
  ['Área afetada', FIELDS.area_afetada],
  ['Focos de incêndio (qtd)', FIELDS.focos_count],
  ['Anos com queimadas', FIELDS.focos_anos],
  ['valor_parcela_credito', FIELDS.valor_parcela_credito],
  ['Instituição (CNPJ básico)', FIELDS.cnpj_basico]
];

const fmtNum = (v) => {
  const n = Number(v);
  return isFinite(n) ? n.toLocaleString('pt-BR', { maximumFractionDigits: 2 }) : (v ?? '').toString();
};
const safe = (x) => (x === null || x === undefined || x === '' ? '—' : String(x));

const map = new mapboxgl.Map({
  container: 'map',
  style: STYLE_URL,
  center: [-60, -6],
  zoom: 4.36,
  projection: 'mercator'
});

async function fetchVectorLayerId(tilesetId) {
  const url = `https://api.mapbox.com/v4/${tilesetId}.json?secure&access_token=${mapboxgl.accessToken}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Falha ao consultar metadata do tileset (${res.status})`);
  const meta = await res.json();
  const vls = (meta.vector_layers || []).map(v => v.id);
  if (!vls.length) throw new Error('Nenhum vector_layer encontrado no tileset.');
  return vls[0];
}

function getStyleLayerIdsByRegex(regex) {
  const layers = map.getStyle().layers || [];
  return layers.map(l => l.id).filter(id => regex.test(id));
}
function setLayersVisibility(layerIds, visible) {
  layerIds.forEach(id => { if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', visible ? 'visible' : 'none'); });
}

const filtersState = { onlyEmbargo: false, onlyTI: false, onlyUC: false };
let SOURCE_LAYER = null;
let lastResults = [];

function buildMapFilter() {
  const clauses = ['all'];
  if (filtersState.onlyEmbargo) {
    clauses.push(['>', ['to-number', ['get', FIELDS.embargo_count], 0], 0]);
  }
  if (filtersState.onlyTI) {
    clauses.push(['==', ['downcase', ['get', FIELDS.TI]], 'sim']);
  }
  if (filtersState.onlyUC) {
    clauses.push(['==', ['downcase', ['get', FIELDS.UC]], 'sim']);
  }
  return clauses;
}

function applyFilters() {
  const expr = buildMapFilter();
  ['credito-fill', 'credito-line'].forEach(id => { if (map.getLayer(id)) map.setFilter(id, expr); });
  scheduleUpdates();
}

function collectVisibleFiltered() {
  const feats = map.queryRenderedFeatures({ layers: ['credito-fill'] }) || [];
  const seen = new Set();
  const rows = [];
  for (const f of feats) {
    const id = f.properties?.[FIELDS.cod_imovel] || f.properties?.[FIELDS.id_car];
    if (!id || seen.has(id)) continue; seen.add(id);
    rows.push({
      cod: id,
      municipio: f.properties?.[FIELDS.municipio] || '—',
      totalCR: Number(f.properties?.[FIELDS.total_CR]) || 0,
      feature: f
    });
  }
  return rows;
}

function renderResultsList() {
  const tbody = document.getElementById('result-rows');
  const rows = collectVisibleFiltered();
  lastResults = rows;
  tbody.innerHTML = '';
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="3">Nenhum resultado na área/filtro atual.</td></tr>';
    return;
  }
  rows.sort((a,b) => b.totalCR - a.totalCR);
  for (const row of rows) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.cod}</td><td>${row.municipio}</td><td>${row.totalCR.toLocaleString('pt-BR', { maximumFractionDigits: 0 })}</td>`;
    tr.addEventListener('click', () => {
      try {
        const b = turf.bbox(row.feature);
        map.fitBounds(b, { padding: 40, duration: 600 });
      } catch (e) { console.warn('BBox error', e); }
    });
    tbody.appendChild(tr);
  }
}

function downloadCSV() {
  if (!lastResults.length) { alert('Sem resultados para exportar.'); return; }
  const lines = ['cod_imovel,municipio,total_CR'];
  lastResults.forEach(r => {
    const esc = (s) => `"${String(s ?? '').replace(/"/g,'""')}"`;
    lines.push([esc(r.cod), esc(r.municipio), r.totalCR].join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'resultado_filtro.csv'; a.click();
  URL.revokeObjectURL(url);
}

let kpiTimer = null;
function scheduleUpdates() {
  if (kpiTimer) cancelAnimationFrame(kpiTimer);
  kpiTimer = requestAnimationFrame(() => { updateKPIs(); renderResultsList(); });
}
function updateKPIs() {
  const feats = map.queryRenderedFeatures({ layers: ['credito-fill'] }) || [];
  const seen = new Set();
  let totalCredito = 0, totalDesmate = 0, cars = 0, comEmbargo = 0;
  for (const f of feats) {
    const id = f.properties?.[FIELDS.cod_imovel] || f.properties?.[FIELDS.id_car] || f.id || JSON.stringify(f.properties);
    if (seen.has(id)) continue; seen.add(id);
    const cr = Number(f.properties?.[FIELDS.total_CR] ?? 0);
    const dm = Number(f.properties?.[FIELDS.desmate] ?? 0);
    const emb = Number(f.properties?.[FIELDS.embargo_count] ?? 0);
    totalCredito += isFinite(cr) ? cr : 0;
    totalDesmate += isFinite(dm) ? dm : 0;
    cars += 1; if (emb > 0) comEmbargo += 1;
  }
  document.getElementById('kpi-credito').textContent = isFinite(totalCredito) ? totalCredito.toLocaleString('pt-BR', { maximumFractionDigits: 0 }) : '—';
  document.getElementById('kpi-desmate').textContent = isFinite(totalDesmate) ? totalDesmate.toLocaleString('pt-BR', { maximumFractionDigits: 0 }) : '—';
  document.getElementById('kpi-cars').textContent = cars || '0';
  document.getElementById('kpi-embargos').textContent = comEmbargo || '0';
}

async function loadGlobalTotals() {
  const totals = { totalCAR: 0, somaCredito: 0, somaDesmate: 0, focosTotal: 0, qtdTI: 0, qtdUC: 0, porInst: [] };

  try {
    const statsUrl = `https://api.mapbox.com/tilesets/v1/${TILESET}/statistics?access_token=${mapboxgl.accessToken}`;
    const r = await fetch(statsUrl);
    if (r.ok) {
      const js = await r.json();
      const layer = (js.layers && js.layers[0]) || js;
      totals.totalCAR = layer && (layer.featureCount || layer.count || layer.layerCount) || 0;

      const crField = (layer.fields && layer.fields[FIELDS.total_CR]) || {};
      totals.somaCredito = (crField && (crField.sum || (crField.summary && crField.summary.sum))) || 0;

      const desField = (layer.fields && layer.fields[FIELDS.desmate]) || {};
      totals.somaDesmate = (desField && (desField.sum || (desField.summary && desField.summary.sum))) || 0;

      const focField = (layer.fields && layer.fields[FIELDS.focos_count]) || {};
      totals.focosTotal = (focField && (focField.sum || (focField.summary && focField.summary.sum))) || 0;

      const tiField = (layer.fields && layer.fields[FIELDS.TI]) || {};
      const ucField = (layer.fields && layer.fields[FIELDS.UC]) || {};
      const catCount = (fld, key='sim') => {
        if (!fld || !fld.categories) return 0;
        const item = fld.categories.find(c => String(c.value).toLowerCase() === key);
        return item ? (item.count || item.frequency || 0) : 0;
      };
      totals.qtdTI = catCount(tiField, 'sim');
      totals.qtdUC = catCount(ucField, 'sim');

      const instField = (layer.fields && layer.fields[FIELDS.cnpj_basico]) || {};
      let pairs = [];
      if (instField.categories) {
        pairs = instField.categories.map(c => ({ inst: c.value || '—', count: c.count || c.frequency || 0 }));
      }
      pairs.sort((a,b) => b.count - a.count);
      totals.porInst = pairs.slice(0, 20);

      if (totals.totalCAR || totals.somaCredito || totals.porInst.length) {
        paintGlobalTotals(totals);
        return;
      }
    }
  } catch (e) {
    console.warn('Falha nas estatísticas do tileset, usando fallback de varredura:', e);
  }

  const prev = { center: map.getCenter(), zoom: map.getZoom(), bearing: map.getBearing(), pitch: map.getPitch() };
  const AMAZ_BOUNDS = [[-74, -17], [-44, 6]];
  await new Promise(res => {
    map.fitBounds(AMAZ_BOUNDS, { padding: 40, duration: 0, maxZoom: 4.36 });
    map.once('idle', res);
  });

  const feats = map.queryRenderedFeatures({ layers: ['credito-fill'] }) || [];
  const seen = new Set();
  const instCount = new Map();
  let somaCredito = 0, somaDesmate = 0, focosTotal = 0, qtdTI = 0, qtdUC = 0, totalCAR = 0;

  for (const f of feats) {
    const id = f.properties?.[FIELDS.cod_imovel] || f.properties?.[FIELDS.id_car];
    if (!id || seen.has(id)) continue; seen.add(id);
    totalCAR += 1;
    const cr = Number(f.properties?.[FIELDS.total_CR] ?? 0);
    if (isFinite(cr)) somaCredito += cr;
    const dm = Number(f.properties?.[FIELDS.desmate] ?? 0);
    if (isFinite(dm)) somaDesmate += dm;
    const foc = Number(f.properties?.[FIELDS.focos_count] ?? 0);
    if (isFinite(foc)) focosTotal += foc;
    const ti = String(f.properties?.[FIELDS.TI] ?? '').toLowerCase() === 'sim';
    const uc = String(f.properties?.[FIELDS.UC] ?? '').toLowerCase() === 'sim';
    if (ti) qtdTI += 1; if (uc) qtdUC += 1;
    const inst = (f.properties?.[FIELDS.cnpj_basico] || '—').trim();
    instCount.set(inst, (instCount.get(inst) || 0) + 1);
  }

  const porInst = [...instCount.entries()].map(([inst, count]) => ({ inst, count })).sort((a,b) => b.count - a.count).slice(0, 20);

  paintGlobalTotals({ totalCAR, somaCredito, somaDesmate, focosTotal, qtdTI, qtdUC, porInst });

  map.jumpTo(prev);
}

function paintGlobalTotals({ totalCAR, somaCredito, somaDesmate, focosTotal, qtdTI, qtdUC, porInst }) {
  const el = (id) => document.getElementById(id);
  el('tot-car').textContent = (totalCAR ?? 0).toLocaleString('pt-BR');
  el('tot-credito').textContent = (somaCredito ?? 0).toLocaleString('pt-BR', { maximumFractionDigits: 0 });
  el('tot-desmate').textContent = (somaDesmate ?? 0).toLocaleString('pt-BR', { maximumFractionDigits: 0 });
  el('tot-focos').textContent = (focosTotal ?? 0).toLocaleString('pt-BR');
  el('tot-ti').textContent = (qtdTI ?? 0).toLocaleString('pt-BR');
  el('tot-uc').textContent = (qtdUC ?? 0).toLocaleString('pt-BR');

  const tbody = document.getElementById('tot-inst-list');
  tbody.innerHTML = '';
  if (!porInst || !porInst.length) {
    tbody.innerHTML = '<tr><td colspan="2">Sem dados de instituição.</td></tr>';
    return;
  }
  for (const row of porInst) {
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = row.inst || '—';
    const td2 = document.createElement('td'); td2.textContent = (row.count || 0).toLocaleString('pt-BR');
    tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
  }
}

function updateEmbargoSuggestions(term) {
  const dl = document.getElementById('embargo-suggestions');
  dl.innerHTML = '';
  if (term.length < 3) return;
  const feats = map.queryRenderedFeatures({ layers: ['credito-fill'] }) || [];
  const seen = new Set();
  const list = [];
  for (const f of feats) {
    const name = (f.properties?.[FIELDS.emb_nome] || '').trim();
    if (!name) continue;
    const low = name.toLowerCase();
    if (!low.includes(term.toLowerCase())) continue;
    if (seen.has(low)) continue;
    seen.add(low); list.push(name);
    if (list.length >= 10) break;
  }
  list.sort().forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    dl.appendChild(opt);
  });
}

map.on('load', async () => {
  try {
    SOURCE_LAYER = await fetchVectorLayerId(TILESET);
    document.getElementById('layerName').textContent = `Layer: ${SOURCE_LAYER}`;

    map.addSource('credito_tiles', { type: 'vector', url: `mapbox://${TILESET}` });

    map.addLayer({
      id: 'credito-fill', type: 'fill', source: 'credito_tiles', 'source-layer': SOURCE_LAYER,
      minzoom: 0, maxzoom: 24,
      paint: { 'fill-color': '#888888', 'fill-opacity': 0.35, 'fill-outline-color': '#ffffff' },
      filter: buildMapFilter()
    });

    map.addLayer({
      id: 'credito-line', type: 'line', source: 'credito_tiles', 'source-layer': SOURCE_LAYER,
      minzoom: 0, maxzoom: 24, paint: { 'line-color': '#000', 'line-width': 0.4, 'line-opacity': 0.7 },
      filter: buildMapFilter()
    });

    map.addLayer({
      id: 'credito-highlight', type: 'line', source: 'credito_tiles', 'source-layer': SOURCE_LAYER,
      minzoom: 0, maxzoom: 24, paint: { 'line-color': '#000', 'line-width': 2 },
      filter: ['==', ['get', FIELDS.cod_imovel], '']
    });

    let hoveredId = null;
    map.on('mousemove', 'credito-fill', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      const f = e.features?.[0]; if (!f) return;
      const cid = f.properties?.[FIELDS.cod_imovel] || '';
      if (cid !== hoveredId) { hoveredId = cid; map.setFilter('credito-highlight', ['==', ['get', FIELDS.cod_imovel], hoveredId]); }
    });
    map.on('mouseleave', 'credito-fill', () => { map.getCanvas().style.cursor = ''; hoveredId = null; map.setFilter('credito-highlight', ['==', ['get', FIELDS.cod_imovel], '']); });

    map.on('click', 'credito-fill', (e) => {
      const p = e.features[0].properties || {}; let rows = '';
      for (const [label, key] of POPUP_FIELDS) {
        if (p[key] === undefined) continue;
        const val = /ha|cr$|cr\)|cr\s|\(r\$\)/i.test(label) ? fmtNum(p[key]) : safe(p[key]);
        rows += `<tr><th>${label}</th><td>${val}</td></tr>`;
      }
      new mapboxgl.Popup({ maxWidth: '480px' }).setLngLat(e.lngLat).setHTML(`<table>${rows || '<tr><td>Sem atributos.</td></tr>'}</table>`).addTo(map);
    });

    const tiLayers = getStyleLayerIdsByRegex(/ind[ií]g|terras?_ind[ií]genas|(^|[-_])ti($|[-_])/i);
    const ucLayers = getStyleLayerIdsByRegex(/unidades?-?de-?conserva[cç][aã]o|cnuc|conservation/i);
    const tiCheckbox = document.getElementById('toggle-ti');
    const ucCheckbox = document.getElementById('toggle-uc');
    setLayersVisibility(tiLayers, tiCheckbox.checked);
    setLayersVisibility(ucLayers, ucCheckbox.checked);
    tiCheckbox.addEventListener('change', () => setLayersVisibility(tiLayers, tiCheckbox.checked));
    ucCheckbox.addEventListener('change', () => setLayersVisibility(ucLayers, ucCheckbox.checked));

    document.getElementById('search').addEventListener('keydown', (ev) => {
      if (ev.key !== 'Enter') return;
      const term = ev.target.value.trim().toUpperCase(); if (!term) return;
      const feats = map.queryRenderedFeatures({ layers: ['credito-fill'] });
      const match = feats.find(ft => (ft.properties?.[FIELDS.cod_imovel] || '').toUpperCase() === term);
      if (match) { const b = turf.bbox(match); map.fitBounds(b, { padding: 40, duration: 600 }); }
      else { alert('cod_imovel não encontrado na área visível/zoom atual. Aproxime/arraste o mapa e tente novamente.'); }
    });

    const embargoInput = document.getElementById('search-embargo');
    embargoInput.addEventListener('input', (ev) => updateEmbargoSuggestions(ev.target.value.trim()));
    embargoInput.addEventListener('keydown', (ev) => {
      if (ev.key !== 'Enter') return;
      const term = ev.target.value.trim().toLowerCase(); if (!term) return;
      const feats = map.queryRenderedFeatures({ layers: ['credito-fill'] });
      const match = feats.find(ft => (ft.properties?.[FIELDS.emb_nome] || '').toLowerCase().includes(term));
      if (match) { const b = turf.bbox(match); map.fitBounds(b, { padding: 40, duration: 600 }); }
      else { alert('Nome de autuado não encontrado na área visível/zoom atual.'); }
    });

    document.getElementById('zoom-br').addEventListener('click', () => {
      map.fitBounds([[-74, -17], [-44, 6]], { padding: 40, duration: 600, maxZoom: 4.36 });
    });

    document.getElementById('apply-filters').addEventListener('click', () => {
      filtersState.onlyEmbargo = document.getElementById('only-embargo').checked;
      filtersState.onlyTI = document.getElementById('only-ti').checked;
      filtersState.onlyUC = document.getElementById('only-uc').checked;
      applyFilters();
    });

    document.getElementById('reset-filters').addEventListener('click', () => {
      ['only-embargo','only-ti','only-uc'].forEach(id => { const el = document.getElementById(id); el.checked = false; });
      filtersState.onlyEmbargo = false; filtersState.onlyTI = false; filtersState.onlyUC = false;
      applyFilters();
    });

    document.getElementById('download-csv').addEventListener('click', downloadCSV);

    map.on('moveend', scheduleUpdates);
    map.on('zoomend', scheduleUpdates);
    scheduleUpdates();

    await loadGlobalTotals();

  } catch (err) {
    console.error(err);
    alert('Erro ao configurar o tileset/layers. Veja o console.');
  }

  map.on('error', (e) => console.error('Mapbox error:', e && e.error));
});
</script>
</body>
</html>
